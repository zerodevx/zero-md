{"version":3,"file":"zero-md.min.js","sources":["../src/index.js"],"sourcesContent":["export class ZeroMd extends HTMLElement {\n  get src() {\n    return this.getAttribute('src')\n  }\n\n  set src(val) {\n    this.reflect('src', val)\n  }\n\n  get manualRender() {\n    return this.hasAttribute('manual-render')\n  }\n\n  set manualRender(val) {\n    this.reflect('manual-render', val)\n  }\n\n  reflect(name, val) {\n    if (val === false) {\n      this.removeAttribute(name)\n    } else {\n      this.setAttribute(name, val === true ? '' : val)\n    }\n  }\n\n  static get observedAttributes() {\n    return ['src']\n  }\n\n  attributeChangedCallback(name, old, val) {\n    if (name === 'src' && this.connected && !this.manualRender && val !== old) {\n      this.render()\n    }\n  }\n\n  constructor(defaults) {\n    super()\n    this.version = '$VERSION'\n    this.config = {\n      markedUrl: 'https://cdn.jsdelivr.net/gh/markedjs/marked@2/marked.min.js',\n      prismUrl: [\n        ['https://cdn.jsdelivr.net/gh/PrismJS/prism@1/prism.min.js', 'data-manual'],\n        'https://cdn.jsdelivr.net/gh/PrismJS/prism@1/plugins/autoloader/prism-autoloader.min.js'\n      ],\n      cssUrls: [\n        'https://cdn.jsdelivr.net/gh/sindresorhus/github-markdown-css@4/github-markdown.min.css',\n        'https://cdn.jsdelivr.net/gh/PrismJS/prism@1/themes/prism.min.css'\n      ],\n      hostCss:\n        ':host{display:block;position:relative;contain:content;}:host([hidden]){display:none;}',\n      ...defaults,\n      ...window.ZeroMdConfig\n    }\n    this.cache = {}\n    this.root = this.hasAttribute('no-shadow') ? this : this.attachShadow({ mode: 'open' })\n    if (!this.constructor.ready) {\n      this.constructor.ready = Promise.all([\n        !!window.marked || this.loadScript(this.config.markedUrl),\n        !!window.Prism || this.loadScript(this.config.prismUrl)\n      ])\n    }\n    this.clicked = this.clicked.bind(this)\n    if (!this.manualRender) {\n      // Scroll to hash id after first render. However, `history.scrollRestoration` inteferes with this\n      // on refresh. It's much better to use a `setTimeout` rather than to alter the browser's behaviour.\n      this.render().then(() => setTimeout(() => this.goto(location.hash), 250))\n    }\n    this.observer = new MutationObserver(async () => {\n      this.observeChanges()\n      if (!this.manualRender) {\n        await this.render()\n      }\n    })\n    this.observeChanges()\n  }\n\n  connectedCallback() {\n    this.connected = true\n    this.fire('zero-md-connected', {}, { bubbles: false, composed: false })\n    this.waitForReady().then(() => {\n      this.fire('zero-md-ready')\n    })\n    if (this.shadowRoot) {\n      this.shadowRoot.addEventListener('click', this.clicked)\n    }\n  }\n\n  disconnectedCallback() {\n    this.connected = false\n    if (this.shadowRoot) {\n      this.shadowRoot.removeEventListener('click', this.clicked)\n    }\n  }\n\n  waitForReady() {\n    const ready =\n      this.connected ||\n      new Promise((resolve) => {\n        this.addEventListener('zero-md-connected', function handler() {\n          this.removeEventListener('zero-md-connected', handler)\n          resolve()\n        })\n      })\n    return Promise.all([this.constructor.ready, ready])\n  }\n\n  fire(name, detail = {}, opts = { bubbles: true, composed: true }) {\n    if (detail.msg) {\n      console.warn(detail.msg)\n    }\n    this.dispatchEvent(\n      new CustomEvent(name, {\n        detail: { node: this, ...detail },\n        ...opts\n      })\n    )\n  }\n\n  tick() {\n    return new Promise((resolve) => requestAnimationFrame(resolve))\n  }\n\n  // Coerce anything into an array\n  arrify(any) {\n    return any ? (Array.isArray(any) ? any : [any]) : []\n  }\n\n  // Promisify an element's onload callback\n  onload(node) {\n    return new Promise((resolve, reject) => {\n      node.onload = resolve\n      node.onerror = (err) => reject(err.path ? err.path[0] : err.composedPath()[0])\n    })\n  }\n\n  // Load a url or load (in order) an array of urls via <script> tags\n  loadScript(urls) {\n    return Promise.all(\n      this.arrify(urls).map((item) => {\n        const [url, ...attrs] = this.arrify(item)\n        const el = document.createElement('script')\n        el.src = url\n        el.async = false\n        attrs.forEach((attr) => el.setAttribute(attr, ''))\n        return this.onload(document.head.appendChild(el))\n      })\n    )\n  }\n\n  // Scroll to selected element\n  goto(id) {\n    if (id) {\n      const el = this.root.getElementById(id.substring(1))\n      if (el) {\n        el.scrollIntoView()\n      }\n    }\n  }\n\n  // Hijack same-doc anchor hash links\n  clicked(ev) {\n    if (ev.metaKey || ev.ctrlKey || ev.altKey || ev.shiftKey || ev.defaultPrevented) {\n      return\n    }\n    const a = ev.target.closest('a')\n    if (a && a.hash && a.host === location.host && a.pathname === location.pathname) {\n      this.goto(a.hash)\n    }\n  }\n\n  dedent(str) {\n    str = str.replace(/^\\n/, '')\n    const match = str.match(/^\\s+/)\n    return match ? str.replace(new RegExp(`^${match[0]}`, 'gm'), '') : str\n  }\n\n  getBaseUrl(src) {\n    const a = document.createElement('a')\n    a.href = src\n    return a.href.substring(0, a.href.lastIndexOf('/') + 1)\n  }\n\n  // Runs Prism highlight async; falls back to sync if Web Workers throw\n  highlight(container) {\n    return new Promise((resolve) => {\n      const unhinted = container.querySelectorAll('pre>code:not([class*=\"language-\"])')\n      unhinted.forEach((n) => {\n        // Dead simple language detection :)\n        const lang = n.innerText.match(/^\\s*</)\n          ? 'markup'\n          : n.innerText.match(/^\\s*(\\$|#)/)\n          ? 'bash'\n          : 'js'\n        n.classList.add(`language-${lang}`)\n      })\n      try {\n        window.Prism.highlightAllUnder(container, true, resolve())\n      } catch {\n        window.Prism.highlightAllUnder(container)\n        resolve()\n      }\n    })\n  }\n\n  // Converts HTML string into node\n  makeNode(html) {\n    const tpl = document.createElement('template')\n    tpl.innerHTML = html\n    return tpl.content.firstElementChild\n  }\n\n  // Construct styles dom and return HTML string\n  buildStyles() {\n    const get = (query) => {\n      const node = this.querySelector(query)\n      return node ? node.innerHTML || ' ' : ''\n    }\n    const urls = this.arrify(this.config.cssUrls)\n    const html = `<div class=\"markdown-styles\"><style>${this.config.hostCss}</style>${get(\n      'template[data-merge=\"prepend\"]'\n    )}${\n      get('template:not([data-merge])') ||\n      urls.reduce((a, c) => `${a}<link rel=\"stylesheet\" href=\"${c}\">`, '')\n    }${get('template[data-merge=\"append\"]')}</div>`\n    return html\n  }\n\n  // Construct md nodes and return HTML string\n  async buildMd(opts = {}) {\n    const src = async () => {\n      if (!this.src) {\n        return ''\n      }\n      const resp = await fetch(this.src)\n      if (resp.ok) {\n        const md = await resp.text()\n        return window.marked(md, {\n          baseUrl: this.getBaseUrl(this.src),\n          ...opts\n        })\n      } else {\n        this.fire('zero-md-error', {\n          msg: `[zero-md] HTTP error ${resp.status} while fetching src`,\n          status: resp.status,\n          src: this.src\n        })\n        return ''\n      }\n    }\n    const script = () => {\n      const el = this.querySelector('script[type=\"text/markdown\"]')\n      if (!el) {\n        return ''\n      }\n      const md = el.hasAttribute('data-dedent') ? this.dedent(el.text) : el.text\n      return window.marked(md, opts)\n    }\n    const html = `<div class=\"markdown-body${\n      opts.classes ? this.arrify(opts.classes).reduce((a, c) => `${a} ${c}`, ' ') : ''\n    }\">${(await src()) || script()}</div>`\n    return html\n  }\n\n  // Insert or replace HTML styles string into DOM and wait for links to load\n  async stampStyles(html) {\n    const node = this.makeNode(html)\n    const links = [...node.querySelectorAll('link[rel=\"stylesheet\"]')]\n    const target = [...this.root.children].find((n) => n.classList.contains('markdown-styles'))\n    if (target) {\n      target.replaceWith(node)\n    } else {\n      this.root.prepend(node)\n    }\n    await Promise.all(links.map((l) => this.onload(l))).catch((err) => {\n      this.fire('zero-md-error', {\n        msg: '[zero-md] An external stylesheet failed to load',\n        status: undefined,\n        src: err.href\n      })\n    })\n  }\n\n  // Insert or replace HTML body string into DOM and returns the node\n  stampBody(html) {\n    const node = this.makeNode(html)\n    const target = [...this.root.children].find((n) => n.classList.contains('markdown-body'))\n    if (target) {\n      target.replaceWith(node)\n    } else {\n      this.root.append(node)\n    }\n    return node\n  }\n\n  // Start observing for changes in root, templates and scripts\n  observeChanges() {\n    this.observer.observe(this, { childList: true })\n    this.querySelectorAll('template,script[type=\"text/markdown\"]').forEach((n) => {\n      this.observer.observe(n.content || n, {\n        childList: true,\n        subtree: true,\n        attributes: true,\n        characterData: true\n      })\n    })\n  }\n\n  async render(opts = {}) {\n    await this.waitForReady()\n    const stamped = {}\n    const pending = this.buildMd(opts)\n    const css = this.buildStyles()\n    if (css !== this.cache.styles) {\n      this.cache.styles = css\n      await this.stampStyles(css)\n      stamped.styles = true\n      await this.tick()\n    }\n    const md = await pending\n    if (md !== this.cache.body) {\n      this.cache.body = md\n      const node = this.stampBody(md)\n      stamped.body = true\n      await this.highlight(node)\n    }\n    this.fire('zero-md-rendered', { stamped })\n  }\n}\n\ncustomElements.define('zero-md', ZeroMd)\n"],"names":["ZeroMd","HTMLElement","src","this","getAttribute","val","reflect","manualRender","hasAttribute","name","removeAttribute","setAttribute","observedAttributes","attributeChangedCallback","old","connected","render","constructor","defaults","super","version","config","markedUrl","prismUrl","cssUrls","hostCss","window","ZeroMdConfig","cache","root","attachShadow","mode","ready","Promise","all","marked","loadScript","Prism","clicked","bind","then","setTimeout","goto","location","hash","observer","MutationObserver","async","observeChanges","connectedCallback","fire","bubbles","composed","waitForReady","shadowRoot","addEventListener","disconnectedCallback","removeEventListener","resolve","handler","detail","opts","msg","console","warn","dispatchEvent","CustomEvent","node","tick","requestAnimationFrame","arrify","any","Array","isArray","onload","reject","onerror","err","path","composedPath","urls","map","item","url","attrs","el","document","createElement","forEach","attr","head","appendChild","id","getElementById","substring","scrollIntoView","ev","metaKey","ctrlKey","altKey","shiftKey","defaultPrevented","a","target","closest","host","pathname","dedent","str","match","replace","RegExp","getBaseUrl","href","lastIndexOf","highlight","container","querySelectorAll","n","lang","innerText","classList","add","highlightAllUnder","makeNode","html","tpl","innerHTML","content","firstElementChild","buildStyles","get","query","querySelector","reduce","c","classes","resp","fetch","ok","md","text","baseUrl","status","script","links","children","find","contains","replaceWith","prepend","l","catch","undefined","stampBody","append","observe","childList","subtree","attributes","characterData","stamped","pending","buildMd","css","styles","stampStyles","body","customElements","define"],"mappings":"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"}